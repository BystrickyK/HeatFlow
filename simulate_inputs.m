%%close all, clear allalpha = 0.05;dx = 0.05;dt = 0.1;k = 74; % thermal conductivity of iron [W/mK]k = k * 0.125;cp = 0.45; % specific heatrho = 7800; % kg/m^3alpha = k / (cp * rho);  % thermal diffusivityFo = alpha * dt / dx^2; % Fourier numberBy = dt / (cp*rho*dx^2) * 10;loss = 1; % loss coefficient [J * K^-1 * s^-1]Co = loss * (cp/rho) * (dt / dx^2); % "environmental heat loss"%%% Set up modelside_elements = 30; % number of elements on each siden_elements = side_elements^2;% Create a general 2D-plate heat transfer model[sys, mats] = create_model_fnum(side_elements, Fo, Co, By);  T_forward = sys;  % Input T_k, u, output T_k+1%%% Function to reshape vector to an image arrayreshape_T = @(T) (reshape(T, [side_elements, side_elements]));% Reshape image array back to a vectorreshape_T_back = @(Tk) reshape(Tk, [n_elements, 1]);% Vector of initial node temperaturesimg = imread('K.png');img = rgb2gray(img);img = imresize(img, [side_elements, side_elements]);img = flip(img);img = 255-img;img = img./255;img = double(img);% Set referenceW = img * 10;T = reshape_T_back(img .* 0);U = reshape_T_back(img .* 0);W = reshape_T_back(W);%% Define control parametersA = mats.A;B = mats.B;N = 5; % prediction horizon% active_inputs = 1:5:n_elements;% B = B(:, active_inputs);% blocksize = length(B);% [blockrows, blockcols] = size(B);Cbar = sparse(blocksize*N, blocksize*N);for i = 1:N    Cbar = Cbar + spblockdiag(A^i * B, N, 0);endAhat = [];a = A;for i = 1:N    Ahat = [Ahat; A^i];endQ = spdiag(blocksize, 0) * 1;Qbar = spblockdiag(Q, N, 0);R = Q * 0.2;Rbar = spblockdiag(R, N, 0);H = (Cbar' * Qbar * Cbar + Rbar);F = (Ahat' * Qbar * Cbar)';% Quadprog parametersUhat = repmat(U, N, 1);  % initial guesslb = Uhat.*0 + 0;ub = Uhat.*0 + 10;options = optimoptions(@quadprog, 'Algorithm', 'interior-point-convex', ...    'Display', 'off');%% Simulatestamp = string(round(rand()*100));% stamp = 'quadprogMPC_lb0';savename = "results" + filesep + string(side_elements) + "_" + stamp;if isfile(savename + '.mat')    disp("Loading solution for stamp: " + stamp)    file = load(savename);    simdata = file.simdata;else    disp("Calculating solution for stamp: " + stamp)    simdata.T = {};    simdata.T{end+1} = T;    simdata.U = {};    simdata.U{end+1} = U;    simdata.E = {};    simdata.E{end+1} = W-T;        Tk = T;    k_steps = 100;        for k = 1:k_steps               % State deviation from reference        E = W - Tk;              % MPC%        f = -(F*E);%        U = -H\f;%        U = U(1:blocksize);       % MPC Quadprog       f = -(F*E);       tic       Uhat = quadprog(H, f,...           [], [],...           [], [],...           lb, ub,...           Uhat, options);       toc       U = Uhat(1:blocksize);       % Proportional%        U = E * 0.5;              % time step forward       Tk = T_forward(Tk, U);              % Save current step       if mod(k,1)==0        simdata.T{end+1} = Tk;        simdata.U{end+1} = U;        simdata.E{end+1} = E;       end              maxabs = max(abs(Tk));       disp([k, maxabs])       if maxabs>1e6           error('Model unstable')       end           end    save(savename, 'simdata')end%% Visualization% Reshape the vector of node temperatures into a 2D array for plottingTk = reshape_T(T);elements = 0:dx:side_elements*dx-dx;[X, Y] = meshgrid(elements, elements);f = figure('Position', [0 0 1400 1000]);t = tiledlayout(2, 3, 'TileSpacing', 'tight', 'Padding', 'tight');ax1 = nexttile([2,2]);% splot = surfc(ax1, X, Y, Tk, 'facealpha', 0.85);[m, splot] = contourf(ax1, X, Y, Tk);splot.LevelStep = 1;splot.LevelList = [-3:0.125:10];splot.LineColor = 'none';axis equalhold onax1.ZLimMode = 'manual';ax1.ZLim = [0 10];   % Z limit is constantax1.CLim = [-3 10];  % Colorbar rangeax1.XLabel.String = 'X';ax1.XLabel.FontSize = 16;ax1.YLabel.String = 'Y';ax1.YLabel.FontSize = 16;colorbarcolormap(turbo)hold offax2 = nexttile(3);yyaxis leftylabel('Mean temperature')meanplot = animatedline(ax2, 'Marker', 'o', 'linewidth', 2, 'color', 'blue');yyaxis rightylabel('Mean square error')errorplot = animatedline(ax2, 'Marker', 'o', 'linewidth', 2, 'color', [1,0.55,0]);grid onax3 = nexttile(6);Uk = reshape_T(simdata.U{1});inputimg = image(ax3, elements', elements', flip(Uk, 1));inputimg.CDataMapping = 'scaled';title('Heat input image')colorbarframes = [getframe(f)];L = length(simdata);t = round(linspace(1, length(simdata.T), 300));t = t - t(1) + 1;framenum = 0;for k = t    disp(k)    framenum = framenum + 1;        T = simdata.T{k};    U = simdata.U{k};    E = simdata.E{k};        Tk = reshape_T(T);    Uk = reshape_T(U);            splot.ZData = Tk;    addpoints(meanplot, k*dt, mean(T));    addpoints(errorplot, k*dt, mean(E.^2));        inputimg.CData = flip(Uk, 1);        drawnow    frames(end+1) = getframe(f);   endwriterObj = VideoWriter('Proportional');writerObj.FrameRate = 20;open(writerObj);for k = 2:length(frames)   frame = frames(k);   writeVideo(writerObj, frame);endclose(writerObj);